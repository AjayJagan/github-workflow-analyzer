<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .nav-tabs .nav-link {
            border: none;
            background: transparent;
            color: #667eea;
        }
        .nav-tabs .nav-link.active {
            background: #667eea;
            color: white;
            border-radius: 5px;
        }
        .workflow-table {
            font-size: 0.9rem;
        }
        .badge-duration {
            background: #ff6b6b;
        }
        .badge-frequency {
            background: #4ecdc4;
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .help-tooltip {
            cursor: help;
            color: #6c757d;
        }
        .chart-help {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .performance-legend {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .legend-item {
            display: inline-block;
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }
        .legend-symbol {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 0.5rem;
            border-radius: 50%;
        }
        .chart-expand-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 10;
        }
        .chart-expand-btn:hover {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .chart-container {
            position: relative;
        }
        .modal-xl {
            max-width: 98%;
            margin: 1rem auto;
        }
        .fullscreen-chart {
            height: 85vh;
            width: 100%;
        }
        .modal-fullscreen {
            width: 100vw;
            max-width: none;
            height: 100vh;
            margin: 0;
        }
        .modal-fullscreen .modal-content {
            height: 100vh;
            border: 0;
            border-radius: 0;
        }
        .modal-fullscreen .modal-body {
            overflow-y: auto;
            padding: 1rem;
        }
        .modal-fullscreen .fullscreen-chart {
            height: calc(100vh - 140px);
        }
        .chart-expand-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-expand-btn:hover {
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-light">
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-3"></i>{{ title }}</h1>
                    <p class="mb-0">Analysis of GitHub workflow performance across repositories</p>
                </div>
                <div class="col-md-4 text-end">
                    <p class="mb-0"><i class="fas fa-clock me-2"></i>Generated: {{ summary.generated_at }}</p>
                    <p class="mb-0"><i class="fas fa-calendar me-2"></i>Analysis Period: {{ summary.analysis_period_days }} days</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Summary Statistics -->
        <div class="row">
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <div class="stat-number">{{ summary.total_workflows }}</div>
                    <div class="text-muted">Total Workflows</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <div class="stat-number text-warning">{{ summary.problematic_workflows }}</div>
                    <div class="text-muted">Problematic</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card text-center">
                    <div class="stat-number">{{ summary.total_repositories }}</div>
                    <div class="text-muted">Repositories</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-number">{{ summary.avg_duration_minutes }}</div>
                    <div class="text-muted">Avg Duration (min)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-number">{{ summary.total_runs_analyzed }}</div>
                    <div class="text-muted">Total Runs Analyzed</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="fas fa-home me-2"></i>Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="workflows-tab" data-bs-toggle="tab" data-bs-target="#workflows" type="button" role="tab">
                    <i class="fas fa-cogs me-2"></i>Workflows
                </button>
            </li>
        </ul>

        <div class="tab-content" id="dashboardTabsContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <!-- Key Criteria Summary -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-bullseye me-2"></i>Workflow Optimization Focus</h5>
                            <p class="mb-2">This analysis identifies workflows from the <strong>last 15 days</strong> that need optimization:</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>CRITICAL:</strong> Frequent (PR/Push) + Slow (>10min) workflows
                                </div>
                                <div class="col-md-6">
                                    <strong>HIGH:</strong> Frequent (>5min) or Very Slow (>15min) workflows
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Problematic Workflows -->
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <button class="chart-expand-btn" onclick="expandChart('top-workflows', 'Top Problematic Workflows')">
                                <i class="fas fa-expand"></i> Expand
                            </button>
                            <div id="top-workflows">
                                {{ charts.top_workflows | safe }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Repository Performance Scorecard -->
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <button class="chart-expand-btn" onclick="expandChart('repository-scorecard', 'Repository Performance Scorecard')">
                                <i class="fas fa-expand"></i> Expand
                            </button>
                            <div id="repository-scorecard">
                                {{ charts.repository_scorecard | safe }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflows Tab -->
            <div class="tab-pane fade" id="workflows" role="tabpanel">
                <div class="mt-3">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="repoFilter" class="form-label">Filter by Repository:</label>
                                <select class="form-select" id="repoFilter" onchange="filterWorkflows()">
                                    <option value="">All Repositories</option>
                                    {% for repo in repositories %}
                                    <option value="{{ repo }}">{{ repo.split('/')[-1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="priorityFilter" class="form-label">Filter by Priority:</label>
                                <select class="form-select" id="priorityFilter" onchange="filterWorkflows()">
                                    <option value="">All Priorities</option>
                                    <option value="critical">Critical</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h5>Workflow Details</h5>
                        <div class="table-responsive">
                            <table class="table table-striped workflow-table" id="workflowTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable(0)" style="cursor: pointer;">Repository <i class="fas fa-sort"></i></th>
                                        <th onclick="sortTable(1)" style="cursor: pointer;">Workflow Name <i class="fas fa-sort"></i></th>
                                        <th onclick="sortTable(2)" style="cursor: pointer;">Avg Duration <i class="fas fa-sort"></i></th>
                                        <th onclick="sortTable(3)" style="cursor: pointer;">Frequency <i class="fas fa-sort"></i></th>
                                        <th onclick="sortTable(4)" style="cursor: pointer;">Total Runs <i class="fas fa-sort"></i></th>
                                        <th onclick="sortTable(5)" style="cursor: pointer;">Priority <i class="fas fa-sort"></i></th>
                                        <th>Triggers</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for workflow in workflows %}
                                    <tr data-repo="{{ workflow.repository }}" 
                                        data-priority="{{ workflow.optimization_priority }}">
                                        <td><span class="badge bg-primary">{{ workflow.repository.split('/')[-1] }}</span></td>
                                        <td>{{ workflow.workflow_name }}</td>
                                        <td>
                                            <span class="badge badge-duration">{{ "%.1f"|format(workflow.avg_duration_minutes) }} min</span>
                                        </td>
                                        <td>
                                            <span class="badge badge-frequency">{{ "%.1f"|format(workflow.frequency_score) }}/day</span>
                                        </td>
                                        <td>{{ workflow.total_runs }}</td>
                                        <td>
                                            {% if workflow.optimization_priority == 'critical' %}
                                                <span class="badge bg-danger">Critical</span>
                                            {% elif workflow.optimization_priority == 'high' %}
                                                <span class="badge bg-warning">High</span>
                                            {% elif workflow.optimization_priority == 'medium' %}
                                                <span class="badge bg-info">Medium</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Low</span>
                                            {% endif %}
                                            {% if workflow.is_pr_triggered %}
                                                <span class="badge bg-primary ms-1">PR</span>
                                            {% endif %}
                                            {% if workflow.is_push_triggered %}
                                                <span class="badge bg-success ms-1">Push</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ workflow.trigger_events | join(', ') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Chart Expansion Modal -->
    <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" id="chartModalDialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalLabel">Chart</h5>
                    <div class="btn-group me-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleFullscreen()" id="fullscreenBtn">
                            <i class="fas fa-expand"></i> Fullscreen
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadChart()" id="downloadBtn">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="expandedChart" class="fullscreen-chart"></div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted me-auto">Use mouse wheel to zoom, drag to pan</small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function filterWorkflows() {
            const repoFilter = document.getElementById('repoFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            const rows = document.querySelectorAll('#workflowTable tbody tr');
            
            rows.forEach(row => {
                const repo = row.dataset.repo;
                const priority = row.dataset.priority;
                
                const showRepo = !repoFilter || repo.includes(repoFilter);
                const showPriority = !priorityFilter || priority === priorityFilter;
                
                if (showRepo && showPriority) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('workflowTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            // Determine sort direction
            const currentDirection = table.dataset.sortDirection || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            table.dataset.sortDirection = newDirection;
            
            // Sort rows
            rows.sort((a, b) => {
                let aVal = a.getElementsByTagName('td')[columnIndex].textContent.trim();
                let bVal = b.getElementsByTagName('td')[columnIndex].textContent.trim();
                
                // Handle numeric columns
                if (columnIndex === 2) { // Duration
                    aVal = parseFloat(aVal.replace(' min', ''));
                    bVal = parseFloat(bVal.replace(' min', ''));
                } else if (columnIndex === 3) { // Frequency
                    aVal = parseFloat(aVal.replace('/day', ''));
                    bVal = parseFloat(bVal.replace('/day', ''));
                } else if (columnIndex === 4) { // Total runs
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                } else if (columnIndex === 5) { // Priority
                    const priorityOrder = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
                    aVal = priorityOrder[aVal.split(' ')[0]] || 0;
                    bVal = priorityOrder[bVal.split(' ')[0]] || 0;
                }
                
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return newDirection === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    return newDirection === 'asc' ? 
                        aVal.localeCompare(bVal) : 
                        bVal.localeCompare(aVal);
                }
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort indicators
            const headers = table.getElementsByTagName('th');
            for (let i = 0; i < headers.length - 1; i++) { // Exclude last column (no sorting)
                const icon = headers[i].querySelector('i');
                if (icon) {
                    if (i === columnIndex) {
                        icon.className = `fas fa-sort-${newDirection === 'asc' ? 'up' : 'down'}`;
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                }
            }
        }

        // Global variables for chart expansion
        let currentChartId = null;
        let isFullscreen = false;

        // Chart expansion functionality
        function expandChart(chartId, chartTitle) {
            currentChartId = chartId;
            const originalChart = document.getElementById(chartId);
            const expandedChart = document.getElementById('expandedChart');
            const modalTitle = document.getElementById('chartModalLabel');
            
            // Set modal title
            modalTitle.textContent = chartTitle;
            
            // Clone the chart content
            expandedChart.innerHTML = originalChart.innerHTML;
            
            // Reset fullscreen state
            isFullscreen = false;
            const modalDialog = document.getElementById('chartModalDialog');
            modalDialog.classList.remove('modal-fullscreen');
            updateFullscreenButton();
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('chartModal'));
            modal.show();
            
            // Trigger Plotly resize for better display
            setTimeout(() => {
                resizeChart();
            }, 300);
        }

        function toggleFullscreen() {
            const modalDialog = document.getElementById('chartModalDialog');
            isFullscreen = !isFullscreen;
            
            if (isFullscreen) {
                modalDialog.classList.add('modal-fullscreen');
            } else {
                modalDialog.classList.remove('modal-fullscreen');
            }
            
            updateFullscreenButton();
            
            // Resize chart after transition
            setTimeout(() => {
                resizeChart();
            }, 300);
        }

        function updateFullscreenButton() {
            const btn = document.getElementById('fullscreenBtn');
            if (isFullscreen) {
                btn.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            } else {
                btn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            }
        }

        function resizeChart() {
            const expandedChart = document.getElementById('expandedChart');
            const plotlyCharts = expandedChart.querySelectorAll('.plotly-graph-div');
            plotlyCharts.forEach(chart => {
                if (window.Plotly) {
                    window.Plotly.Plots.resize(chart);
                }
            });
        }

        function downloadChart() {
            const expandedChart = document.getElementById('expandedChart');
            const plotlyChart = expandedChart.querySelector('.plotly-graph-div');
            
            if (plotlyChart && window.Plotly) {
                const filename = currentChartId ? `${currentChartId}-chart` : 'workflow-chart';
                window.Plotly.downloadImage(plotlyChart, {
                    format: 'png',
                    width: 1200,
                    height: 800,
                    filename: filename
                });
            }
        }

        // Handle ESC key for fullscreen exit
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
        });

        // Auto-resize on window resize
        window.addEventListener('resize', function() {
            if (document.getElementById('chartModal').classList.contains('show')) {
                setTimeout(resizeChart, 100);
            }
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</body>
</html>